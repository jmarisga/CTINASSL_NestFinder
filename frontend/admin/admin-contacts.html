<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Contact Messages</title>

  <!-- CSS -->
  <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../assets/css/fontawesome.css" />
  <link rel="stylesheet" href="../assets/css/templatemo-villa-agency.css" />
  <link rel="stylesheet" href="../assets/css/owl.css" />
  <link rel="stylesheet" href="../assets/css/animate.css" />

  <style>
    .admin-content { display: none; }
    .loading-auth { min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .main-nav .logo h1 { font-size: 24px !important; text-transform: uppercase; }
    .main-nav .nav li:last-child a { padding: 8px 20px !important; border-radius: 20px; background-color: #1e1e1e; color: #fff !important; display: flex; align-items: center; justify-content: center; }
    .main-nav .nav li:last-child a:hover { background-color: #f35525; }
    .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; cursor: pointer; display: inline-block; }
    .status-unread { background: #ffc107; color: #000; }
    .status-read { background: #28a745; color: #fff; }
    #contacts-table-container :is(th, td):nth-child(1) { width: 60px; }
    #contacts-table-container :is(th, td):nth-child(2) { width: 100px; }
    #contacts-table-container :is(th, td):nth-child(3) { width: 80px; }
    #contacts-table-container :is(th, td):nth-child(4) { width: 150px; }
    #contacts-table-container :is(th, td):nth-child(5) { width: 200px; }
    #contacts-table-container :is(th, td):nth-child(6) { width: auto; min-width: 350px; }
    #contacts-table-container :is(th, td):nth-child(7) { width: 100px; }
    #contacts-table-container :is(th, td):nth-child(8) { width: 100px; }
    #contacts-table-container td:nth-child(6) { white-space: normal; word-break: break-word; text-align: left; }
    .subject-line { font-weight: 600; color: #333; margin-bottom: 4px; }
  </style>
</head>

<body>
  <!-- Auth Loading Screen -->
  <div id="auth-loading" class="loading-auth">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Verifying authentication...</p>
  </div>

  <!-- Admin Content -->
  <div class="admin-content">
    <!-- Preloader -->
    <div id="js-preloader" class="js-preloader">
      <div class="preloader-inner">
        <span class="dot"></span>
        <div class="dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>

    <!-- ADMIN NAVBAR -->
    <header class="header-area header-sticky">
      <div class="container">
        <div class="row">
          <div class="col-12">
            <nav class="main-nav">
              <a href="admin-dashboard.html" class="logo">
                <h1>Admin</h1>
              </a>

              <ul class="nav">
                <li><a href="admin-dashboard.html">Dashboard</a></li>
                <li><a href="admin-properties.html">Properties</a></li>
                <li><a href="admin-users.html">Users</a></li>
                <li><a href="admin-visits.html">Visits</a></li>
                <li><a href="admin-contacts.html" class="active">Contacts</a></li>
                <li><a href="#" id="logout-btn">Logout</a></li>
              </ul>

              <a class="menu-trigger">
                <span>Menu</span>
              </a>
            </nav>
          </div>
        </div>
      </div>
    </header>

    <!-- PAGE HEADER -->
    <div class="page-heading header-text">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <h3>Contact Messages</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- CONTACTS TABLE -->
    <div class="section">
      <div class="container mt-4">
        
        <!-- Loading indicator -->
        <div id="contacts-loading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2">Loading messages...</p>
        </div>

        <!-- Error message -->
        <div id="contacts-error" class="alert alert-danger d-none"></div>

        <!-- Empty state -->
        <div id="contacts-empty" class="text-center py-5 d-none">
          <i class="fa fa-envelope-open fa-3x text-muted mb-3"></i>
          <p class="text-muted">No contact messages found.</p>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered table-striped text-center align-middle" id="contacts-table-container" style="display: none;">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Date</th>
                <th>Time</th>
                <th>Name</th>
                <th>Email</th>
                <th>Subject & Message</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody id="contacts-table">
              <!-- Data from JS -->
            </tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- FOOTER -->
    <footer>
      <div class="container">
        <div class="col-lg-12">
          <p>© 2025 NestFinder Admin Panel — All rights reserved.</p>
        </div>
      </div>
    </footer>
  </div>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="../assets/js/custom.js"></script>
  <script src="../assets/js/admin-auth.js"></script>

  <script>
    const escapeHtml = (text) => { const div = document.createElement('div'); div.textContent = text || ''; return div.innerHTML; };
    const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A';
    const formatTime = (dateString) => dateString ? new Date(dateString).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : 'N/A';

    async function loadContacts() {
      const els = { loading: document.getElementById('contacts-loading'), error: document.getElementById('contacts-error'), empty: document.getElementById('contacts-empty'), table: document.getElementById('contacts-table-container'), body: document.getElementById('contacts-table') };

      try {
        const response = await AdminAuth.apiRequest('/contacts');
        if (!response.ok) throw new Error('Failed to load contacts');
        
        const contacts = await response.json();
        els.body.innerHTML = '';
        els.loading.style.display = 'none';

        if (contacts.length === 0) { els.empty.classList.remove('d-none'); return; }

        contacts.forEach((contact, index) => {
          const status = contact.status === 'read' ? 'read' : 'unread';
          const row = els.body.insertRow();
          const subjectMsg = contact.subject ? `<div class="subject-line">${escapeHtml(contact.subject)}</div>${escapeHtml(contact.message)}` : escapeHtml(contact.message);
          row.innerHTML = `
            <td><small>${index + 1}</small></td>
            <td><small>${formatDate(contact.createdAt)}</small></td>
            <td><small>${formatTime(contact.createdAt)}</small></td>
            <td>${escapeHtml(contact.name)}</td>
            <td>${escapeHtml(contact.email)}</td>
            <td>${subjectMsg}</td>
            <td><span class="status-badge status-${status} status-toggle" data-id="${contact._id}" data-status="${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
            <td><button class="btn btn-danger btn-sm delete-contact" data-id="${contact._id}"><i class="fa fa-trash"></i> Delete</button></td>
          `;
        });

        els.table.style.display = 'table';
      } catch (error) {
        console.error('Load contacts error:', error);
        els.loading.style.display = 'none';
        els.error.textContent = error.message || 'Failed to load contacts';
        els.error.classList.remove('d-none');
      }
    }

    async function updateStatus(contactId, newStatus) {
      try {
        const response = await AdminAuth.apiRequest(`/contacts/${contactId}/status`, { method: 'PATCH', body: JSON.stringify({ status: newStatus }) });
        if (!response.ok) throw new Error((await response.json()).message || 'Failed to update status');
        alert('Status updated successfully');
      } catch (error) {
        alert(error.message);
        loadContacts();
      }
    }

    async function deleteContact(contactId) {
      if (!confirm('Are you sure you want to delete this message?')) return;
      try {
        const response = await AdminAuth.apiRequest(`/contacts/${contactId}`, { method: 'DELETE' });
        if (!response.ok) throw new Error((await response.json()).message || 'Failed to delete contact');
        alert('Contact deleted successfully');
        loadContacts();
      } catch (error) { alert(error.message); }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      if (!AdminAuth.protectPage()) return;
      document.getElementById('auth-loading').style.display = 'none';
      document.querySelector('.admin-content').style.display = 'block';
      loadContacts();

      document.getElementById('logout-btn').addEventListener('click', (e) => { e.preventDefault(); if (confirm('Are you sure you want to logout?')) AdminAuth.logout(); });
      document.getElementById('contacts-table').addEventListener('click', (e) => {
        const statusToggle = e.target.closest('.status-toggle');
        if (statusToggle) { const newStatus = statusToggle.dataset.status === 'read' ? 'unread' : 'read'; updateStatus(statusToggle.dataset.id, newStatus); }
        const deleteBtn = e.target.closest('.delete-contact');
        if (deleteBtn) deleteContact(deleteBtn.dataset.id);
      });
    });
  </script>

</body>

</html>
